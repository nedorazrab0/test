#!/usr/bin/env bash

pacman -Sy archiso --noconfirm --disable-sandbox
ls -lh /usr/share/archiso/configs/baseline

cat << EOF > /usr/share/archiso/configs/baseline/profiledef.sh
iso_name="archlinux-baseline"
iso_label="ARCH_$(date --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}" +%Y%m)"
iso_publisher="Arch Linux <https://archlinux.org>"
iso_application="Arch Linux baseline"
iso_version="$(date --date="@${SOURCE_DATE_EPOCH:-$(date +%s)}" +%Y.%m.%d)"
install_dir="arch"
buildmodes=('iso')
#bootmodes=('bios.syslinux.mbr' 'bios.syslinux.eltorito'
#           'uefi-ia32.grub.esp' 'uefi-x64.grub.esp'
#           'uefi-ia32.grub.eltorito' 'uefi-x64.grub.eltorito')
arch="x86_64"
pacman_conf="pacman.conf"
airootfs_image_type="erofs"
airootfs_image_tool_options=('-zzstd' '--ultra' '-T0' '-20')
bootstrap_tarball_compression=(zstd -c -T0 --long --ultra -20)
file_permissions=(
  ["/etc/shadow"]="0:0:400"
)
EOF

rm -rf /usr/share/archiso/configs/baseline/{syslinux,grub}
mkarchiso -v /usr/share/archiso/configs/baseline
